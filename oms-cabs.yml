_include:
  - (quartical)stimela_cabs.yaml[optional]
  - (cubical)stimela/stimela_cabs.yaml[optional]

## this augments the standard 'cabs' config section
cabs:
  wsclean:
    image: ''
    command: /home/oms/src/wsclean/build/wsclean

  dummy:
    image: ''
    command: echo
    inputs:
      args:
        dtype: List[str]
        policies:
          positional: true
          repeat: repeat

  wsclean_pol:
    policies:
      skip_implicits: true
    image: ''
    command: /home/oms/src/wsclean/build/wsclean

  mkdir:
    command: mkdir
    inputs:
      dir:
        dtype: str
        policies:
          positional: true

  mv:
    command: mv
    policies:
      positional: true
    inputs:
      src:
        dtype: File
        required: true
    outputs:  
      dest:
          dtype: Union[File, Directory]
          required: true

  cp:
    command: cp -a
    policies:
      positional: true
    inputs:
      src:
        dtype: File
        required: true
    outputs:
      dest:
        dtype: Union[File, Directory]
        required: true

  print_uniq_column_values:
    command: "python3 -c 'from casacore.tables import table; import sys; print(len(set(table(sys.argv[1]).getcol(sys.argv[2]))),sys.argv[3]);'"
    policies:
      positional: true
    inputs:
      ms:
        dtype: MS
        required: true
      column:
        default: 'TIME'
      label:
        default: 'timeslots'

  stack_freq_cube:
    command: fitstool.py
    inputs:
      images:
        dtype: List[File]
        required: true
        policies:
          positional: true
          repeat: repeat
    outputs:
      cube:
        dtype: File
        policies:
          positional: true
          format: '--stack={0}:FREQ'

  fitstool:
    command: fitstool.py
    inputs:
      images:
        dtype: List[File]
        required: true
        policies:
          positional: true
          repeat: repeat
      mean:
        dtype: bool
      diff:
        dtype: bool
      force:
        dtype: bool
        default: true
    outputs:
      output:
        dtype: File

  pybdsm:
    command: ./run_pybdsm.py
    parameter_passing: yaml
    inputs:
      image:
        dtype: File
      spectralindex_do:
        dtype: bool
        default: false
      flagging_opts:
        dtype: bool
        default: false
      flag_maxsize_bm:
        dtype: float
        required: false
      rms_box:
        required: false
        dtype: Tuple[int, int]
      thresh_isl:
        dtype: float
        default: 3
      thresh_pix:
        dtype: float
        default: 5
      catalog_type:
        choices: [srl, gaul, shap]
        default: srl
      catalog_format:
        choices: [bbs, ds9, fits, star, kvis, ascii, csv, casabox, sagecal]
        default: ascii
      rms_map:
        dtype: bool
        required: false
    outputs:
      outfile:
        dtype: File

  tigger_convert:
    command: tigger-convert
    inputs:
      src:
        dtype: File
        required: true
        policies:
          positional: true
      force:
        dtype: bool
        default: true
    outputs:
      dest:
        dtype: File
        policies:
          positional: true

  crystalball:
    command: crystalball
    virtual_env: ~/.venv/cball
    policies:
      prefix: '--'
      replace: {'_': '-'}
    inputs:
      ms:
        dtype: MS
        writable: true
        required: true
        policies:
          positional: true
      output_column:
        dtype: str
        required: true
      sky_model:
        dtype: File
        required: true
      within:
        dtype: File
      num_sources:
        dtype: int

  breizorro:
    command: breizorro
    policies:
      replace: {'_': '-'}
    inputs:
      restored_image:
        dtype: File
      mask_image:
        dtype: File
      merge:
        dtype: Union[str, List[str]]
      subtract:
        dtype: Union[str, List[str]]
      threshold:
        dtype: float
        default: 6.5
      dilate:
        dtype: int
      number_islands:
        dtype: bool
      extract_islands:
        dtype: List[str]
        policies:
          repeat: list
      remove_islands:
        dtype: List[str]
        policies:
          repeat: list
      invert:
        dtype: bool
      make_binary:
        dtype: bool
    outputs:
      mask:
        dtype: File
        nom_de_guerre: outfile
        required: true 

  taql_update:
    command: "taql update"
    policies:
      positional: true
    inputs:
      ms:
        dtype: MS
        required: true
      commands:
        dtype: List[str]
        policies:
          repeat: list

  convolve_image:
    command: (image_utils)convolve_image
    inputs:
      image:
        dtype: File
        required: true
      size_arcsec:
        dtype: float
      size_pix:
        dtype: float
    outputs:
      outimage:
        dtype: File

  extract_fits_timestamps:
    command: (image_utils)extract_fits_timestamps
    inputs:
      images:
        dtype: List[File]
        required: true
    outputs:
      outfile:
        dtype: File

  extract_light_curves:
    command: (image_utils)extract_light_curves
    inputs:
      cube:
        dtype: File
      catalog:
        dtype: File
      timestamps:
        dtype: File
      outdir:
        dtype: Directory
        mkdir: true
        must_exist: false
      nsrc:
        dtype: int
        default: 100
      ra0:
        dtype: str
        default:
      dec0:
        dtype: str
        default:
      within_deg:
        dtype: float
        required: false
      minsize_arcsec:
        dtype: float
        default: 10
    outputs:
      regfile:
        dtype: File

  flagman:
    command: flagmanager
    flavour: casa-task
    # command: casa --nogui --log2term -c 'flagmanager(vis="{current.ms}", mode="{current.mode}", versionname="{current.name}")'
    inputs:
      ms: 
        dtype: MS
        required: true
        nom_de_guerre: vis
      versionname:
        info: "flag version name"
      mode: 
        choices: [save, restore, list]
        required: true

  flagsummary:
    command: flagdata
    flavour: casa-task
    inputs:
      ms: 
        dtype: MS
        required: true
        nom_de_guerre: vis
      spw:
        dtype: str
        default: all
      mode:
        implicit: 'summary'

  smops:
    command: smops --ms {current.ms}
    policies:
      prefix: '-'
    inputs:
      od:
        dtype: Directory
        mkdir: true
        must_exist: false
      nthreads:
        dtype: int
      stokes:
        dtype: str
        default: I
      ms:
        dtype: MS
        policies:
          skip: true
      ip:
        required: true
        dtype: str
      co:
        required: true
        dtype: int
      order:
        dtype: int

    outputs:
      model-prefix:
        implicit: =IFSET(current.od,SELF,'.') + "/" + BASENAME(current.ip)
      model:
        dtype: List[File]
        implicit: =GLOB("{current.model-prefix}*model*fits")

lib:
  steps:
    wsclean:
      base:
        info: "base wsclean settings"
        cab: wsclean
        params:
          padding: 1.3
          nwlayers-factor: 3
          use-wgridder: true
          log-time: true

      dirty:
        _use: lib.steps.wsclean.base
        info: "wsclean step for dirty-only image"
        params:
          column: CORRECTED_DATA
          niter: 0
          # parallel_gridding: 64

      dirty_pol:
        _use: lib.steps.wsclean.dirty
        info: "wsclean step for dirty-only IQUV image"
        cab: wsclean_pol
        params:
          pol: IQUV

      image:
        _use: lib.steps.wsclean.dirty
        info: "wsclean step for imaging"
        params:
          fit-beam: true
          elliptical-beam: true
#          parallel-deconvolution: 1500
          join-channels: true
          mgain: 0.9

      image_pol:
        _use: lib.steps.wsclean.image
        info: "wsclean step for IQUV imaging"
        cab: wsclean_pol
        params:
          join-polarizations: true
          fit-spectral-pol: =UNSET
          pol: IQUV
          mgain: 0.9

      predict:
        _use: lib.steps.wsclean.base
        info: "wsclean step for predicting a model"
        params:
          predict: true

      predict_pol:
        _use: lib.steps.wsclean.predict
        info: "wsclean step for predicting an IQUV model"
        cab: wsclean_pol
        params:
          predict: true
          pol: IQUV

      predict_pol2:
        _use: lib.steps.wsclean.predict_pol
        info: "wsclean step for predicting an IQ model"
        params:
          pol: IQUV


    quartical:
      base:
        cab: quartical
        params:
          input_ms:
            time_chunk: '16'
            freq_chunk: '0'
            group_by: [SCAN_NUMBER,FIELD_ID,DATA_DESC_ID]
            select_uv_range: [150, 0]
            select_corr: [0, 3]
          input_model:
            apply_p_jones: false
          solver:
            terms: [K]
            iter_recipe: [25]
            propagate_flags: true
            robust: false
          output:
            overwrite: true
            products: [corrected_data]
            columns: [CORRECTED_DATA]
            flags: true
            apply_p_jones_inv: false
          mad_flags:
            enable: true
            threshold_bl: 5
            threshold_global: 5
            max_deviation: 5
          K:
            time_interval: 1
            freq_interval: 0
            type: delay



